---
title: Azure 統合 (アプリ用 Common Data Service) | Microsoft Docs
description: <Description>
ms.custom: ''
ms.date: 10/31/2018
ms.reviewer: ''
ms.service: powerapps
ms.topic: article
author: brandonsimons
ms.author: jdaly
manager: ryjones
search.audienceType:
  - developer
search.app:
  - PowerApps
  - D365CE
---
# <a name="azure-integration"></a>Azure 統合

アプリ用 Common Data Service (CDS) は Azure による認証をサポートします。 開発者は、アプリ用 CDS でのプラグインを登録できます。それは実行コンテキストと呼ばれる実行時メッセージ データをクラウド内の 1 つ以上の Azure ソリューションに渡すことができます。 これは特に重要です。なぜなら Azure は、プラグインで取得された実行時コンテキストを外部の基幹業務 (LOB) アプリケーションに伝達するためにサポートされている 2 つのソリューションの 1 つだからです。 もう 1 つのソリューションは、サンドボックスに登録されたプラグインから外部のカスタム エンドポイントへのアクセス機能です。

Azure Service Bus は、アプリ用 CDS 実行時データと外部クラウド ベースの基幹業務 (LOB) アプリケーション間で、安全性および信頼性が確保された通信チャネルを提供します。 この機能が特に役立つのは、異種アプリ用 CDS システムまたは他のアプリ用 CDS サーバーとのビジネス データ変更による同期を保つ場合です。

## <a name="key-elements-of-the-connection"></a>接続の主な要素  

 アプリ用 CDS と Azure Service Bus 間の接続を実装する主な要素は、後ほど説明します。 次のセクションの図には、操作中のこれらの要素が表示されます。  
  
 ### <a name="data-context"></a>データのコンテキスト 

 *データ コンテキスト*には、現在のアプリ用 CDS 操作の一部として処理されるビジネス データが含まれます。 この処理は、ユーザー、ワークフロー、またはアプリケーションが、Dynamics 365 プラットフォームに対して特定の操作を実行するように要求したときに起動したものです。 データのコンテキストは、現在処理中の特定の要求およびエンティティの組合せで実行される、イベント パイプラインに登録されたプラグインまたはカスタム ワークフロー活動に渡されます。 データ コンテキストは、イベント実行パイプラインに沿って渡されるときは <xref:Microsoft.Xrm.Sdk.IPluginExecutionContext> の種類で、サービス ハブに投稿されるときは <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext> です。  
  
 Azure Service Bus に投稿されるメッセージ内に含まれるデータ コンテキストは、既定の .NET バイナリ形式に加え、 XML または JSON 形式である場合があります。 これによりクロスプラットフォームの相互運用が可能となります。ここでは Azure がホストする非 .NET クライアントがサービス バスから アプリ用 CDS データを読み取ることができます。 

> [!IMPORTANT]
> HTTP ペイロード全体のサイズが 192Kb を超えると、次のプロパティが削除されます:
>
> - <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.ParentContext>
> - <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.InputParameters>
> - <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.PreEntityImages>
> - <xref:Microsoft.Xrm.Sdk.RemoteExecutionContext.PostEntityImages>
>
> 一部の操作では、次のプロパティは含まれません。 
>
> - 追加データが削除された後にペイロードのサイズが 192kb を超える場合、追加の `MessageMaxSizeExceeded` プロパティは、システムが送信した [BrokeredMessage](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage) に追加されます。 これはデータの一部が切捨てられたことを示します。
> - 追加データが削除された後にペイロードのサイズが 192Kb を超える場合、エラーが発生し、メッセージは送信されません。
  
 前述のテクノロジーの詳細については、次を参照してください。
 - [イベント実行パイプライン](event-framework.md#event-execution-pipeline)
 - [Microsoft Azure ソリューション用リスナー アプリケーションの記述](write-listener-application-azure-solution.md)。  
  
 ### <a name="plug-ins"></a>プラグイン  
 プラグインは、Azure Service Bus へのデータ コンテキストを含むメッセージの投稿を開始するのに使用される 2 つのメソッドのうちの 1 つです。他のメソッドはユーザー定義のワークフロー活動です。 Dynamics 365-Azure 接続機能によってサポートされるプラグイン、は 2 種類あります。標準 (OOB) およびカスタムです。 いずれの場合も、システムのベスト パフォーマンスのため、非同期で実行するようプラグインを登録することをお勧めします。  
  
 Azure 対応の OOB プラグインには、アプリ用 CDS が付属しており、プラグイン登録ツールを使用して登録できます。 このプラグインは、アプリ用 CDS プラットフォームとの完全な信頼関係により実行されます。 イベント実行パイプラインでプラグイン「ステップ」を登録する必要があります。このステップでは、投稿の通知の実行および処理のためのプラグインをトリガーする、メッセージとエンティティの組合せを識別します。 実行するとき、プラグインは非同期サービスを通知し、サービス エンドポイント通知サービス (<xref:Microsoft.Xrm.Sdk.IServiceEndpointNotificationService>) を介し、現在の要求データ コンテキストを Azure Service Bus に投稿します。  
  
 また、“Azure 対応“ の独自のカスタム プラグインを作成することもできます。 カスタム プラグインは、部分信頼でサンドボックス内で実行します。 カスタム プラグインは、サービス エンドポイントの通知を介し、サービス バスに対するデータ コンテキストの投稿を開始することができます。 このサービスを呼び出すコードを追加すると、プラグインは “Azure 対応“になります。 
 
 プラブイン全般の詳細については、 [プラグインの記述](write-plug-in.md)を参照してください。 Azure 対応プラグインの詳細については、[Azure 対応のカスタム プラグインの記述](write-custom-azure-aware-plugin.md) を参照してください。  
  
 ### <a name="custom-workflow-activities"></a>ユーザー定義のワークフロー活動  
 プラグインと同様に、ユーザー定義のワークフロー活動を記述して、サービス エンドポイント通知サービスを使用し、Azure Service Bus に対する現在の要求メッセージ データの投稿を開始することができます。 詳細: [ワークフロー拡張](workflow/workflow-extensions.md) 
  
 ### <a name="asynchronous-service"></a>非同期サービス  
 サービス エンドポイント通知サービスにより通知されると、非同期サービスは、イベント実行パイプラインが現在処理している要求メッセージのデータ コンテキストの、Azure Service Bus に対する投稿を処理します。 各ポストは非同期サービスのシステム ジョブによって実行されます。 ユーザーは、PowerApps Web アプリケーションの**システム ジョブ**ビューを使用して、各システム ジョブのステータスを表示することができます。  
  
 非同期サービスの詳細については、「[非同期サービス](asynchronous-service.md)」を参照してください。  
  
 ### <a name="microsoft-azure-service-bus"></a>Microsoft Azure のサービス バス  
 このサービス バスは、要求メッセージ データのコンテキストをアプリ用 CDS および Azure Service Bus ソリューション リスナー アプリケーションの間で中継します。 またサービス バスは、投稿した Dynamics 365 データには承認済みのアプリケーションのみがアクセスできるよう、データ セキュリティを提供します。  アプリ用 CDS がデータ コンテキストをサービス バスに投稿し、リスナー アプリケーションがそれを読む承認は、Azure Shared Access Signature (SAS) で管理されます。  
  
  
 サービス バスの詳細については、[サービス バス](https://azure.microsoft.com/en-us/services/service-bus/) を参照してください。 サービス バス認証の詳細については、 [サービス バスの認証および承認](https://azure.microsoft.com/en-us/documentation/articles/service-bus-authentication-and-authorization/) を参照してください。  
  
 ### <a name="microsoft-azure-solution"></a>Microsoft Azure ソリューション

 アプリ用 CDS および Azure 接続が作動するためには、Azure Service Bus ソリューション アカウントに少なくとも 1 つのソリューションがあり、そのソリューションに 1 つ以上のサービス エンドポイントが含まれる必要があります。 リレー エンドポイント契約では、“アプリ用 CDS 対応“ であるリスナー アプリケーションは、サービス バスでのアプリ用 CDS の要求をエンドポイントでアクティブにリスニングする必要があります。 キュー エンドポイント契約では、リスナーはアクティブにリスニングする必要はありません。 リスナーをアプリ用 CDS 対応にするには、<xref:Microsoft.Xrm.Sdk> アセンブリにリンクして、<xref:Microsoft.Xrm.Sdk.RemoteExecutionContext> の型が定義されるようにします。 詳細: [Microsoft Azure ソリューション用リスナーの記述](write-listener-application-azure-solution.md)  
  
 アプリ用 CDS は Azure イベント ハブ ソリューションへのイベント データの送信をサポートします。 イベント ハブの詳細については、[Azure イベント ハブ ソリューションのイベント データとの連携](work-event-data-azure-event-hub-solution.md) を参照してください。  
  
<a name="bkmk_describing"></a>  
 
## <a name="cds-for-apps-to-service-bus-scenario"></a>アプリ用 CDS をサービス バス シナリオへ  

 ここでは、これまでに説明した接続コンポーネントを実装するシナリオについて説明します。 前提条件として、SAS はアプリ用 CDS をサポートされている発行者として認識しており、リスナーがリスニングしているエンドポイントにポストできるルールが Azure Service Bus ソリューションに構成されています。  
  
 次の図は、シナリオを構成する物理要素を示しています。  
  
 ![Dynamics 365 をサービス バス シナリオへ](media/crm-v5s-az.png "アプリ用 CDS をサービス バス シナリオへ")  
  
 この図に示すイベントの順序は次のとおりです。  
  
1. リスナー アプリケーションが Azure Service Bus ソリューション エンドポイントに登録され、アプリ用 CDS リモート実行コンテキストをサービス バスでアクティブなリスニングを開始します。  

2. ユーザーがアプリ用 CDS で何かの操作を実行し、登録済みの OOB プラグインまたはカスタム Azure 対応プラグインの実行がそれによってトリガーされます。 プラグインが、非同期サービス システム ジョブを介して、現在の要求データ コンテキストのサービス バスへのポストを開始します。  
  
3. アプリ用 CDS によってポストされたクレームが認証されます。 次に、サービス バスが、リモート実行コンテキストをリスナーに渡します。 リスナーはコンテキスト情報を処理し、その情報に対してビジネス関連タスクを実行します。 サービス バスから非同期サービスにポストの成功が通知され、関連するシステム ジョブが完了ステータスに設定されます。  
  
<a name="bkmk_establising"></a>  
 
## <a name="establish-a-contract-between-cds-for-apps-and-an-azure-solution"></a>アプリ用 CDS と Azure ソリューションの契約の確立  
 ソリューション エンドポイントごとに契約を構成して、サービス バスでのこれらのリモート実行コンテキストの "メッセージ" の処理と、そのエンドポイントで使用する必要があるセキュリティを定義します。 サービス バス メッセージは、ここに示す 1 件のサポート契約を使用してエンドポイントで受信されます。  
  
 **キュー**  
 キュー契約は、クラウドでメッセージ キューを提供します。 キュー契約では、リスナーはエンドポイントでメッセージをアクティブにリスニングする必要はありません。 キューに対しては破壊読み取りと非破壊読み取りがあります。 破壊読み取りでは、キューにあるメッセージが読み取られ、メッセージが削除されます。 非破壊読み取りでは、メッセージがキューから削除されません。  
  
 アプリ用 CDS でサポートされる種類のキューは、永久キューと呼ばれます。 永久キューでは、コードで指定することができる、有効期間が長く有限のメッセージがあります。  
  
 **一方向**  
 一方向契約ではアクティブなリスナーが必要です。 エンドポイントにアクティブなリスナーがないと、サービス バスへのポストが失敗します。 要求を投稿する非同期システム ジョブが最終的に中止され、そのステータスが "失敗" にセットされるまで、アプリ用 CDS は指数関数的に長い期間、投稿を再試行します。  
  
 **二方向**  
 双方向契約は一方向契約と似ていますが、リスナーからポストを開始したプラグインまたはユーザー定義ワークフロー活動に、文字列値が返される点で異なります。  
  
 **停止**  
 REST 契約は REST エンドポイントでの二方向契約に似ています。  
  
 **トピック**  
 一つ以上のリスナーがトピックをサブスクライブしてトピックからメッセージを受信することができること以外は、キューに似ています。  
  
 **イベント ハブ**  
 この契約の種類は Azure イベント ハブ ソリューションに適用されます。  
  
> [!IMPORTANT]
>  これらの契約を使用するには、[Azure SDK](http://www.windowsazure.com/develop/downloads/) v1.7 またはそれ以降を使用して、リスナー アプリケーションを記述する必要があります。  
  
 契約の構成では、契約で使用されるセキュリティの種類を指定します。 契約は、Transport Layer Security (TLS) または Secure Sockets Layer (SSL) (https) を使用するトランスポート セキュリティを使用できます。  
  
 クレーム認証は、サービス バスに対するセキュリティで保護されたアクセスのために使用されます。 サービス バスへの認証で使用されるクレームは、アプリ用 CDS 内で生成され、アプリ用 CDS 構成データベースに指定されている AppFabricIssuer 証明書によって署名されます。  
  
<a name="bkmk_management"></a>

## <a name="manage-run-time-errors"></a>ランタイム エラーの管理  

 サービス バスへのポストが試行された後でエラーが発生した場合は、Web アプリケーションの関連するシステム ジョブのステータスを調べて、エラーの詳細を確認します。 サービス バスが停止しているか、リスナーまたはエンドポイントが使用できない場合、アプリ用 CDS で処理されている現在のメッセージはバスにポストされません。 非同期サービスはメッセージのポスト試行を継続しますが、最初は頻繁に試行されるものの、その後は試行間隔が急激に長くなります。 内部のアプリ用 CDS エラーの場合、メッセージのポストは試行されません。 外部のサービス バスまたはネットワークのエラーの場合、関連するシステム ジョブは「待機」状態になります。