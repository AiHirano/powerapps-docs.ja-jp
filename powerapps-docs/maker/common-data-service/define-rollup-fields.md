---
title: PowerApps を使用してロールアップ フィールドを定義する | MicrosoftDocs
description: ロールアップ フィールドを定義する方法について説明します
ms.custom: ''
ms.date: 05/23/2018
ms.reviewer: ''
ms.service: crm-online
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
applies_to:
- Dynamics 365 (online)
- Dynamics 365 Version 9.x
- powerapps
author: Mattp123
ms.assetid: ff0504a1-01bd-4f9b-b884-7f84911d86c3
caps.latest.revision: 58
ms.author: matp
manager: kvivek
ms.openlocfilehash: c76162747ac2bda27c46895290e5943b7f46739f
ms.sourcegitcommit: aba996b1773ecdf62758e06b34eaf57bede29e08
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/08/2018
ms.locfileid: "39690614"
---
# <a name="define-rollup-fields-that-aggregate-values"></a>値を集計するロールアップ フィールドを定義する

ロールアップ フィールドは、主要なビジネス指標を監視することで、ユーザーがデータに関する分析情報を得るのに役立ちます。 ロールアップ フィールドには、指定されたレコードに関連するレコードに対して計算された集計値が含まれています。 これには、メールや予定などの標準的なエンティティと活動エンティティが含まれます。

より複雑なシナリオでは、レコードの階層にわたるデータを集計できます。 管理者またはカスタマイザーの場合は、PowerApps のカスタマイズ ツールを使用して、ロールアップ フィールドを定義できます。コードを記述する必要はありません。  
  
<a name="BKMK_benefitsandcapabilities"></a> 
 
## <a name="rollup-fields-benefits-and-capabilities"></a>ロールアップ フィールドの利点と機能  

ロールアップ フィールドの利点と機能は次のとおりです。  
  
- ビジュアル編集が簡単です。 通常のフィールドを作成する場合とまったく同じように、フィールド エディターを使用して、ロールアップ フィールドを作成できます。  
- さまざまな集計関数から選択できます。 `SUM`、`COUNT`、`MIN`、`MAX`、`AVG` という関数を使用して、データを集計できます。  
- 集計のための完全なフィルター サポート。 複数の条件を設定すると同時に、ソース エンティティまたは関連エンティティに対して各種フィルターを設定できます。  
- ユーザー インターフェイスとのシームレスな統合。 フォーム、ビュー、グラフ、レポートにロールアップ フィールドを含めることができます。  
- ロールアップ フィールドはソリューション コンポーネントです。 ロールアップ フィールドを環境間でコンポーネントとして簡単に転送し、ソリューションに分散することができます。  
- ロールアップ フィールドと計算フィールドは相互補完的です。 ロールアップ フィールドを計算フィールドの一部として、また、逆に計算フィールドをロールアップ フィールドの一部として使用できます。  
- カスタム コントロールを使用するようにロールアップ フィールドを構成することができます。  
  
 ロールアップ フィールドの例をいくつか以下に示します。  
  
- 取引先企業のオープンされている営業案件の売上見込み合計  
- 1 つの階層内のすべての取引先企業に関してオープンされている営業案件の売上見込み合計  
- 子営業案件を含む営業案件の売上見込み合計  
- キャンペーンによって発生した見込みのある潜在顧客の見込み値合計  
- 1 つの階層内のすべての取引先企業に関して高優先度のオープンされているケースの数  
- 1 つの取引先企業に関して高優先度のオープンされているすべてのケースが最も早く作成された時刻  
  
各ロールアップ フィールドでは、*&lt;fieldname&gt;*`_date` と *&lt;fieldname&gt;*`_state` のサフィックス パターンで、2 つの付属フィールドが作成されます。 `_date` フィールドには日時データが含まれ、`_state` フィールドには整数データが含まれます。 `_state` フィールドには次の値が示されます。  
  
|値|状態|説明|  
|-|-|-|  
|0|NotCalculated|フィールド値はまだ計算されていません。|  
|1|集計値|フィールド値は、_date フィールドの最終更新時間ごとに計算されています。|  
|2|OverflowError|フィールド値の計算によってオーバーフロー エラーが発生しました。|  
|3|OtherError|フィールド値の計算は内部エラーによって失敗しました。 ほとんどの場合、次の計算ジョブの実行によって修正されます。|  
|4|RetryLimitExceeded|同時実行およびロック競合が多いことが原因で、値の計算の最大再試行数を超えたため、フィールド値の計算に失敗しました。|  
|5|HierarchicalRecursionLimitReached|計算の対象となる階層の深さの最大制限に達したため、フィールド値の計算に失敗しました。|  
|6|LoopDetected|レコードの階層で再帰的ループが検出されたため、フィールド値の計算に失敗しました。|  
  
<a name="BKMK_calculations"></a>  
 
## <a name="rollup-calculations"></a>ロールアップ計算  

ロールアップは、バックグラウンドで非同期に実行される、スケジュールされたシステム ジョブによって計算されます。 ロールアップ ジョブを表示して管理するには、管理者である必要があります。 

### <a name="view-rollup-jobs"></a>ロールアップ ジョブを表示する

ロールアップ ジョブを表示するには、次のようにします。

1. **Common Data Service の既定のソリューション**を表示している間に、URL を編集して `dynamics.com` 以降のすべてを削除してからページを更新します。
2. **[設定]** 領域で、**[システム]** > **[システム ジョブ]** の順に選択します。<br />![システム ジョブに移動する](media/navigate-system-jobs.png)
1. ビュー セレクターで、**[定期的なシステム ジョブ]** を選びます。
2. 関連するジョブをすばやく見つけるために、システム ジョブの種類 (**ロールアップ フィールドの一括計算**または **ロールアップ フィールドの計算**) でフィルター処理することできます。
 
### <a name="mass-calculate-rollup-field"></a>ロールアップ フィールドの一括計算

**ロールアップ フィールドの一括計算**は、ロールアップ フィールドごとに作成される、定期的なジョブです。 これは、ロールアップ フィールドの作成または更新後に 1 回行われます。 ジョブでは、このフィールドが含まれる既存のすべてのレコード内の指定されたロールアップ フィールドの値が再計算されます。 既定では、ジョブは、フィールドが作成または更新されてから 12 時間後に実行されます。 このジョブは、完了した後、遠い将来、約 10 年後に実行されるように自動的にスケジュールされます。 フィールドが変更された場合、更新後、12 時間以内に再度実行するようにジョブがリセットされます。 **ロールアップ フィールドの一括計算**が環境の非稼働時間中に確実に行われるようにするには、12 時間の遅延が必要です。 ロールアップ フィールドの作成後または変更後に、**ロールアップ フィールドの一括計算**が非稼働時間中に行われるように、その開始時刻を管理者が調整することをお勧めします。 たとえば、ロールアップ フィールドの効率的な処理が確実に行われるようにする場合、ジョブ実行の適切な時間は午前 0 時となります。  

### <a name="calculate-rollup-field"></a>ロールアップ フィールドの計算 

**ロールアップ フィールドの計算**は定期的なジョブであり、指定されたエンティティに関する既存のレコード内のすべてのロールアップ フィールドが逐次計算されます。 **ロールアップ フィールドの計算**ジョブはエンティティごとに 1 つのみとなります。 逐次計算は、最後の**ロールアップ フィールドの一括計算**ジョブの実行が終了した後に作成、更新、または削除されたレコードを、**ロールアップ フィールドの計算**ジョブで処理することを意味します。 既定の最大繰り返し設定値は 1 時間です。 ジョブは、エンティティで最初のロールアップ フィールドが作成されるときに自動的に作成され、最後のロールアップ フィールドが削除されるときに削除されます。  

## <a name="online-recalculation-option"></a>オンライン再計算オプション
以下に示すように、フォーム上のロールアップ フィールドにカーソルを合わせると、最後のロールアップの時刻を表示できます。また、そのフィールドの横にある更新アイコンを選択して、ロールアップ値を更新することができます。  

![アカウント フォーム上のロールアップ フィールド](media/rollup-field-on-account-form.png)
  

オンライン再計算オプション (フォーム上の手動更新) を使用する際に注意する必要がある考慮事項がいくつかあります。  
  
- エンティティに対する書き込み特権と、更新を要求するソース レコードに対する書き込みアクセス権が必要です。 たとえば、取引先企業のオープンされている営業案件から売上見込みを計算する場合、書き込み特権は営業案件エンティティに対しては必要ありません。この特権は取引先企業エンティティに対してのみ必要になります。  
- このオプションはオンライン モードでのみ使用できます。 オフラインで作業を行っている間は使用できません。  
- ロールアップ更新時の最大レコード数は、50,000 レコードに制限されます。 階層のロールアップの場合、これはその階層全体の関連レコードに適用されます。 制限を超えた場合、"*関連レコードの計算制限数である 50,000 に達したため、オンラインで計算することはできません*" などのエラー メッセージが表示されます。 ロールアップがシステム ジョブで自動的に再計算される場合、この制限は適用されません。  
- ソース レコードに関する階層の最大の深さは、10 に制限されます。 制限を超えた場合、"*ソース レコードに関する階層の深さの制限である 10 に達したため、オンラインで計算することはできません*" などのエラー メッセージが表示されます。 ロールアップがシステム ジョブで自動的に再計算される場合、この制限は適用されません。  

## <a name="modify-rollup-job-recurrence"></a>ロールアップ ジョブの繰り返しを変更する

システム管理者として、ロールアップ ジョブの繰り返しパターンを変更できます。また、ロールアップ ジョブを延期、一時停止、再開することができます。 しかし、ロールアップ ジョブをキャンセルしたり、削除したりすることはできません。 

繰り返しパターンを一時停止、延期、再開、または変更するには、システム ジョブを表示する必要があります。 詳細については、「[ロールアップ ジョブを表示する](#view-rollup-jobs)」を参照してください。 

ナビゲーション バーで、**[アクション]** を選択してから、必要なアクションを選びます。 

**ロールアップ フィールドの一括計算**ジョブの場合、**[再開]**、**[延期]**、**[一時停止]** から選択できます。 

**ロールアップ フィールドの計算**ジョブの場合、**[繰り返しの変更]**、**[再開]**、**[延期]**、**[一時停止]** から選択できます。  
  
<a name="BKMK_businessscenarios"></a>  
 
## <a name="examples"></a>例 

ロールアップ フィールドの例をいくつか見てみましょう。 階層を使用して、また使用せずに、関連レコードからレコードのデータを集計します。 関連アクティビティから、また、ActivityParty エンティティを通じてレコードに間接的に関連するアクティビティからもレコードのデータを集計します。 それぞれの例では、フィールド エディターを使用して、ロールアップ フィールドを定義します。 フィールド エディターを開くには、ソリューション エクスプローラーを開き、**[コンポーネント]** > **[エンティティ]** の順に展開します。 必要なエンティティを選び、**[フィールド]** を選択します。 **[新規]** を選択します。 エディターで、**フィールドの種類**や**データの種類**など、フィールドに必要な情報を入力します。 データの種類を選んでから、**[フィールドの種類]** で **[ロールアップ]** を選択します。 データの種類には、小数、整数、通貨、日時があります。 **[フィールドの種類]** の横にある **[編集]** ボタンを選択します。 これにより、ロールアップ フィールド定義エディターが表示されます。 ロールアップ フィールド定義は、**[ソース エンティティ]**、**[関連エンティティ]**、**[集計]** という 3 つのセクションで構成されています。  
  
-   **[ソース エンティティ]** セクションで、ロールアップ フィールドが定義されるエンティティと、階層全体で集計するかどうかを指定します。 複数の条件を設定したフィルターを追加して、ロールアップで使用する階層内のレコードを指定することができます。  
  
-   **[関連エンティティ]** セクションで、集計対象のエンティティを指定します。 ソース エンティティの階層でのロールアップを選択した場合、このセクションは省略可能です。 複数の条件を指定したフィルターを追加して、計算に使用する関連レコードを指定することができます。 たとえば、年間売り上げが $1,000 を超える、オープンされている営業案件からの売り上げを含めます。  
  
-   **[集計]** セクションで、計算するメトリックを指定します。 SUM、COUNT、MIN、MAX、AVG など、利用可能な集計関数から選ぶことができます。  
  
### <a name="aggregate-data-for-a-record-from-related-records"></a>関連レコードからレコードのデータを集計する  

この例では、階層は使用されません。 関連するオープンされている営業案件から、取引先企業の売上見込み合計が計算されます。  

![取引先企業の売上見込みを集計する](media/rollup-field-no-hierarchy.png)
  
### <a name="aggregate-data-for-a-record-from-the-child-records-over-the-hierarchy"></a>階層全体の子レコードからレコードのデータを集計する 
 
この例では、階層全体の子営業案件を含む営業案件の売上見込み合計を計算します。  
  
![営業案件階層で売上見込みを集計する](media/rollup-field-hierarchy-self.png)
  
### <a name="aggregate-data-for-a-record-from-the-related-records-over-the-hierarchy"></a>階層全体の関連レコードからレコードのデータを集計する

この例では、階層全体のすべての取引先企業でオープンされている営業案件の売上見込み合計を計算します。  
  
![取引先企業階層全体の売上見込みを集計する](media/rollup-field-hierarchy.png)  
  
### <a name="aggregate-data-for-a-record-from-all-related-activities"></a>すべての関連アクティビティからレコードのデータを集計する
  
この例では、取引先企業に関連するすべてのアクティビティから、課金対象となる費やされた時間の合計を計算します。 これには、電話、予定、またはカスタム アクティビティで費やされた時間が含まれる場合があります。  
  
以前のリリースでは、電話通話、FAX、予定などの個々のアクティビティに対して、ロールアップ フィールドを定義できました。 しかし、以下に示す例の結果を得るには、計算フィールドを使用してデータを合計する必要がありました。 現在は、アクティビティ エンティティに対してロールアップ フィールドを 1 つ定義することで、すべて 1 つの手順で行うことができます。  
  
![取引先企業に関するすべてのアクティビティをロールアップする](media/rollup-enhancements-activities.png)  
  
### <a name="aggregate-data-for-a-record-from-all-related-activities-and-activities-indirectly-related-via-the-activity-party-entity"></a>すべての関連アクティビティから、また、Activity Party エンティティを通じて間接的に関連するアクティビティからレコードのデータを集計する  

この例では、取引先企業に送信されたメールの総数をカウントします。この場合、取引先企業はメールの "宛先" 行または "CC 受信者" 行にリストされます。 これは、ロールアップ フィールド定義の Activity Party エンティティに対して、**[フィルター]** で **[参加の種類]** を指定して行います。 フィルター処理を使わない場合、アクティビティで利用可能なすべての参加の種類が計算に使用されます。 
 
特定のアクティビティで利用可能な Activity Party エンティティと参加の種類の詳細については、「[ActivityParty エンティティ](/dynamics365/customer-engagement/developer/activityparty-entity)」を参照してください。

  
![関連アクティビティと Activity Party をロールアップする](media/rollup-enhancements-indirect-activities.png)  
  
### <a name="aggregate-data-for-a-record-from-related-records-using-the-avg-operator"></a>AVG 演算子を使用して関連レコードからレコードのデータを集計する

この例では、取引先企業に関連するすべての営業案件から売上見込み平均を計算します。  
  
![Dynamics 365 の売上見込み平均](media/rollup-enhancements-average.PNG)  
  
次の例では、取引先企業の階層にわたる関連する営業案件から、売上見込み平均を計算する方法を示します。 売上見込み平均は階層内の各レベルで表示できます。  
  
![Dynamics 365 の売上見込み平均](media/cust-rollup-enhancements-avg-over-hierarchy.png)  
  
<a name="BKMK_considerations"></a> 

## <a name="rollup-field-considerations"></a>ロールアップ フィールドに関する考慮事項 

ロールアップ フィールドを操作する場合は、次の特定の条件と制限事項に注意してください。  
  
- 組織に対して最大 100 個のロールアップ フィールドを、エンティティごとに最大 10 個のロールアップ フィールドを定義することができます。  
- ロールアップ フィールドの更新によってワークフローをトリガーすることはできません。  
- ワークフローの待機条件でロールアップ フィールドを使用することはできません。  
- ロールアップ フィールドに対するロールアップはサポートされていません。  
- ロールアップでは別の計算フィールドを使用する計算フィールドを参照することはできません。他の計算フィールドのすべてのフィールドが現在のエンティティにある場合でも同様です。  
- ロールアップでフィルターを適用できるのは、ソース エンティティまたは関連エンティティ、シンプルなフィールドまたは複雑でない計算フィールドに対してのみです。  
- 1:N リレーションシップ エンティティに対してのみロールアップを行うことができます。 N:N リレーションシップに対してロールアップを行うことはできません。  
- Activity エンティティや Activity Party エンティティの場合、1:N リレーションシップに対してロールアップを行うことはできません。  
- ビジネス ルール、ワークフローまたは計算フィールドでは常に、ロールアップ フィールドの最後の計算値が使用されます。  
- ロールアップ フィールドは、システム ユーザーのコンテキストで集計されます。 すべてのユーザーに同じロールアップ フィールドの値を表示できます。 ロールアップ フィールドの表示は、フィールド レベル セキュリティ (FLS) を使用して、ロールアップ フィールドにアクセスできるユーザーを制限することで制御できます。 詳細については、「[アクセスを制御するフィールド レベル セキュリティ](/dynamics365/customer-engagement/admin/field-level-security)」を参照してください。 

### <a name="precision-rounding"></a>有効桁数の丸め処理
 
集計フィールドの有効桁数がロールアップ フィールドの有効桁数より多い場合、集計が行われる前に、集計フィールドの桁数はロールアップの桁数に丸められます。 この動作を確認するために、具体的な例を見てみましょう。 たとえば、関連する営業案件の売上見込み合計を計算する場合に、取引先企業エンティティのロールアップ フィールドに小数点以下 2 桁が表示されるとします。 営業案件 エンティティの売上見込みフィールドは、小数点以下 4 桁の集計フィールドです。 この例では、取引先企業に 2 つの関連する営業案件が存在しています。 売上見込みの集計は次のように計算されます。  
  
1. 最初の 営業案件の売上見込み: $1000.0041  
1. 2 番目の 営業案件の売上見込み: $2000.0044  
1. 売上見込みの 集計: $1000.00 + $2000.00 = $3000.00

ご覧のように、集計が行われる前に、集計フィールドの小数点以下は 2 桁に丸められます。  
  
### <a name="different-behavior-from-associated-grids"></a>関連するグリッドとは異なる動作
 
取引先企業や連絡先など、すぐに使用できる特定のエンティティ フォームには関連するグリッドが含まれます。 たとえば、取引先企業フォームには、連絡先、ケース、営業案件および他のグリッドが含まれます。 取引先企業フォーム グリッドに表示されるレコードの一部は、取引先企業レコードに直接関連付けられます。その他は、他のレコードとのリレーションシップを通じて、間接的に関連付けられます。 一方、ロールアップ フィールド集計では、ロールアップ フィールド定義で明示的に定義されている直接的リレーションシップのみが使用されます。 他のリレーションシップは考慮されません。 動作の違いを確認するために、次の例を見てみましょう。  
  
1. 取引先企業 A1 には取引先責任者 P1 がいます。 ケース C1 は取引先企業 A1 に関連付けられ (C1.Customer フィールド = A1)、ケース C2 は取引先責任者 P1 に関連付けられています (C2.Customer フィールド = P1)。  
1. A1 レコードの**取引先企業**フォームの**ケース**には、2 つのケース (C1 と C2) が表示されます。  
1. ケースの合計数という取引先企業エンティティのロールアップ フィールドは、取引先企業に関連付けられたケースをカウントするために使用されます。  
1. 取引先企業ロールアップ フィールド定義で、取引先企業と顧客リレーションシップがあるケースを指定します。 集計後のケースの合計数は 1 になります (ケース C1)。 ケース C2 は、取引先企業ではなく連絡先に直接関連付けられており、取引先企業ロールアップ フィールド定義で明示的に定義できないため、合計には含まれません。 そのため、ロールアップ操作によって返されるケースの合計数は、**ケース** グリッドで示されるケース数と一致しません。  
  
### <a name="see-also"></a>関連項目  

[フィールドの作成と編集](create-edit-fields.md)<br />
[計算フィールドの定義](define-calculated-fields.md)<br />
[日時フィールドの動作と形式](behavior-format-date-time-field.md)<br />
[階層的な関連データの定義とクエリを行う](define-query-hierarchical-data.md)<br />
[ビデオ: ロールアップと計算フィールド](http://www.youtube.com/watch?v=RoahCH1p3T8&list=PLC3591A8FE4ADBE07&index=8)<br />
[ビデオ: Power BI の使用](http://www.youtube.com/watch?v=PkQe4BFlBS8&list=PLC3591A8FE4ADBE07&index=3)
